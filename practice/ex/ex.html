<html>
<script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>
<link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" />
<script src="https://jsuites.net/v4/jsuites.js"></script>
<link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>


<div id="spreadsheet"></div>
<input type="file" id="fileUploader" name="fileUploader" accept=".xls, .xlsx">

<p><button id='download'>Export my spreadsheet as CSV</button></p>
<select name="data-select" id="data_select">

</select>

<button id="draw">draw</button>
<canvas id="myChart" style="width:800; height:500;"></canvas>

</br></br>
JSON : <label id="jsonObject"> </label>

<script src="../../../../js-library/execl/xlsx.full.min.js"></script>
<script src="../../../../js-library/jquery-1.12.4.min.js"></script>



<script>
    let arr;
    let x;
    const arr_sec = [];
    const arr_fir = [];
    let arr_ex=[];
    const $data=document.querySelector('#data_select');
    // let j;
    $(document).ready(function () {
        $("#fileUploader").change(function (evt) {
            var selectedFile = evt.target.files[0];
            var reader = new FileReader();
            reader.onload = function (event) {
                var data = event.target.result;
                var workbook = XLSX.read(data, {
                    type: 'binary'
                });
                workbook.SheetNames.forEach(function (sheetName) {
                    var XL_row_object = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
                    if (XL_row_object.length > 0) {
                        document.getElementById("jsonObject").innerHTML = JSON.stringify(XL_row_object);
                        // j= JSON.stringify(XL_row_object);
                    }
                    arr = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
                    x = jspreadsheet(document.getElementById('spreadsheet'), {
                        data: arr,
                        tableOverflow: true,
                        columns: [
                            //{title : 'dd',
                            // name : 'dd',
                            // witdh : '150px'}
                        ]
                    });
                    for (key in arr) {
                        arr_fir.push(Object.values(arr[key])[0]); // 첫 열
                        arr_sec[key] = Object.values(arr[key])[1]; // 두번째 열
                    }
                    for (var i = 0; i < Object.keys(arr[1]).length; i++) {
                        data_select.innerHTML += "<Option value='select-column' id='select-column'>" + Object.keys(arr[0])[i] + "</option>";
                    }
                })
            };
            reader.onerror = function (event) {
                console.error("File could not be read! Code " + event.target.error.code);
            };
            //           
            reader.readAsBinaryString(selectedFile);
        });


        document.getElementById('download').onclick = function () {
            x.download(); // 파일 이름 설정?
        }

        // dropdown에서 열 추출
        const onclick = function () {
            console.log($data.options[$data.selectedIndex].textContent);
            var name_column = $data.options[$data.selectedIndex].textContent;
            console.log(arr);
        };
        $data.addEventListener('click', onclick);

        // 그래프 그리기
        document.getElementById('draw').onclick = function () {
            // x축 변수들
            const labels = [
                arr_fir
            ];
            // 데이터
            const data = {
                labels: labels,
                datasets: [{
                    label: 'My First dataset',
                    backgroundColor: 'rgb(255, 255,255)',
                    borderColor: 'rgb(255, 99, 132)',
                    data: arr_sec,
                    fill: false,
                }]
            };
            // 설정 값
            const config = {
                type: 'line',
                data: data,
                options: {
                    responsive: false,
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    },
                }
            };
            // 그리기
            const myChart = new Chart(
                document.getElementById('myChart'),
                config
            );
        };

    });

    // 각종 
    var changed = function (instance, cell, x, y, value) {
        var cellName = jexcel.getColumnNameFromId([x, y]);
        $('#log').append('New change on cell ' + cellName + ' to: ' + value + '');
    }

    var beforeChange = function (instance, cell, x, y, value) {
        var cellName = jexcel.getColumnNameFromId([x, y]);
        $('#log').append('The cell ' + cellName + ' will be changed');
    }

    var insertedRow = function (instance) {
        $('#log').append('Row added');
    }

    var insertedColumn = function (instance) {
        $('#log').append('Column added');
    }

    var deletedRow = function (instance) {
        $('#log').append('Row deleted');
    }

    var deletedColumn = function (instance) {
        $('#log').append('Column deleted');
    }

    var sort = function (instance, cellNum, order) {
        var order = (order) ? 'desc' : 'asc';
        $('#log').append('The column  ' + cellNum + ' sorted by ' + order + '');
    }

    var resizeColumn = function (instance, cell, width) {
        $('#log').append('The column  ' + cell + ' resized to width ' + width + ' px');
    }

    var resizeRow = function (instance, cell, height) {
        $('#log').append('The row  ' + cell + ' resized to height ' + height + ' px');
    }

    var selectionActive = function (instance, x1, y1, x2, y2, origin) {
        var cellName1 = jexcel.getColumnNameFromId([x1, y1]);
        var cellName2 = jexcel.getColumnNameFromId([x2, y2]);
        $('#log').append('The selection from ' + cellName1 + ' to ' + cellName2 + '');
    }

    var loaded = function (instance) {
        $('#log').append('New data is loaded');
    }

    var moveRow = function (instance, from, to) {
        $('#log').append('The row ' + from + ' was move to the position of ' + to + ' ');
    }

    var moveColumn = function (instance, from, to) {
        $('#log').append('The col ' + from + ' was move to the position of ' + to + ' ');
    }

    var blur = function (instance) {
        $('#log').append('The table ' + $(instance).prop('id') + ' is blur');
    }

    var focus = function (instance) {
        $('#log').append('The table ' + $(instance).prop('id') + ' is focus');
    }

    var paste = function (data) {
        $('#log').append('Paste on the table ' + $(instance).prop('id') + '');
    }

</script>

</html>